package com.vip.apitest.luxury.magento;

import static com.jayway.restassured.RestAssured.given;
import static com.jayway.restassured.path.json.JsonPath.with;
import static com.jayway.restassured.module.jsv.JsonSchemaValidator.matchesJsonSchema;
import static org.hamcrest.Matchers.*;

import java.io.InputStream;
import java.security.MessageDigest;

import com.vip.apitest.luxury.common.CommonMethod;
import com.vip.apitest.utility.MagentoDB;
import junit.framework.Assert;
import org.junit.Test;
import com.vip.apitest.utility.MD5Encoder;
import com.vip.apitest.luxury.common.User;


/**
 * Created by Administrator on 2014/6/18.
 */
public class UserTest {


    @Test
    public void testLoginWithNewUser() throws Exception{
        Long currentTime = System.currentTimeMillis();
        String userName = currentTime + "@vip.com";
        String password = "vipshop123456";
        String md5Password = MD5Encoder.encodeByMD5(password, MessageDigest.getInstance("MD5"));

        given().relaxedHTTPSValidation().
                params("username", userName).
                params("password", md5Password).
                params("gender", "1").
                params("ip", "127.0.0.1").
        when().
                get("http://passport.api.vip.com/api/passport/register/register").
        then().
                body("expends", notNullValue()).
                body("errorCode", equalTo(0)).
                statusCode(200);

        String requestStr = "{";
        requestStr += "\"" + "username" + "\":" + "\"" + userName + "\"" + ",";
        requestStr += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
        requestStr += "\"" + "invite_code" + "\":" + "\"" + MagentoDB.getAvaliableInviteCode() + "\"";
        requestStr += "}";

        given().
                body(requestStr).
                header("Content-Type", "application/json; charset=utf-8").
                header("appid", "10001").
                when().
                post("http://shop-mapp.vipfashion.com/api/rest/customer/login").
        then().
                body("code", equalTo(1)).
                statusCode(200);
    }

    @Test
    public void createNewUserInMangento() throws Exception{
        Long currentTime = System.currentTimeMillis();
        String userName = currentTime + "@vip.com";
        String password = "vipshop123456";

        String md5Password = MD5Encoder.encodeByMD5(password, MessageDigest.getInstance("MD5"));

        given().relaxedHTTPSValidation().
                params("username", userName).
                params("password", md5Password).
                params("gender", "1").
                params("ip", "127.0.0.1").
                when().
                get("http://passport.api.vip.com/api/passport/register/register").
                then().
                body("expends", notNullValue()).
                body("errorCode", equalTo(0)).
                statusCode(200);

        String requestStr = "{";
        requestStr += "\"" + "username" + "\":" + "\"" + userName + "\"" + ",";
        requestStr += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
        requestStr += "\"" + "invite_code" + "\":" + "\"" + MagentoDB.getAvaliableInviteCode() + "\"";
        requestStr += "}";

        given().
                body(requestStr).
                header("Content-Type", "application/json; charset=utf-8").
                header("appid", "10001").
                when().
                post("http://shop-mapp.vipfashion.com/api/rest/customer/login").
                then().
                body("code", equalTo(1)).
                statusCode(200);
    }


    @Test
    public void testInviteCodeIsUsedOnlyOnce() throws Exception{
        Long currentTime = System.currentTimeMillis();
        String userName = currentTime + "@vip.com";
        String password = "vipshop123456";
        String md5Password = MD5Encoder.encodeByMD5(password, MessageDigest.getInstance("MD5"));
        String inviteCode = MagentoDB.getAvaliableInviteCode();

        given().relaxedHTTPSValidation().
                params("username", userName).
                params("password", md5Password).
                params("gender", "1").
                params("ip", "127.0.0.1").
        when().
                get("http://passport.api.vip.com/api/passport/register/register").
        then().
                body("expends", notNullValue()).
                body("errorCode", equalTo(0)).
                statusCode(200);

        String requestStr = "{";
        requestStr += "\"" + "username" + "\":" + "\"" + userName + "\"" + ",";
        requestStr += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
        requestStr += "\"" + "invite_code" + "\":" + "\"" + inviteCode + "\"";
        requestStr += "}";

        given().
                body(requestStr).
                header("Content-Type", "application/json; charset=utf-8").
                header("appid", "10001").
                when().
                post("http://shop-mapp.vipfashion.com/api/rest/customer/login").
                then().
                body("code", equalTo(1)).
                statusCode(200);

        currentTime = System.currentTimeMillis();
        String userName2 = currentTime + "@vip.com";

        given().relaxedHTTPSValidation().
                params("username", userName2).
                params("password", md5Password).
                params("gender", "1").
                params("ip", "127.0.0.1").
                when().
                get("http://passport.api.vip.com/api/passport/register/register").
                then().
                body("expends", notNullValue()).
                body("errorCode", equalTo(0)).
                statusCode(200);

        String requestStr2 = "{";
        requestStr2 += "\"" + "username" + "\":" + "\"" + userName2 + "\"" + ",";
        requestStr2 += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
        requestStr2 += "\"" + "invite_code" + "\":" + "\"" + inviteCode + "\"";
        requestStr2 += "}";

        given().
                body(requestStr2).
                header("Content-Type", "application/json; charset=utf-8").
                header("appid", "10001").
                when().
                post("http://shop-mapp.vipfashion.com/api/rest/customer/login").prettyPrint();
//                then().
//                body("code", equalTo(1)).
//                statusCode(200);
    }

    @Test
    public void testLoginWithExistedUser() throws Exception{
        String userName = MagentoDB.getExistedUser();
        String md5Password = MD5Encoder.encodeByMD5("vipshop123456", MessageDigest.getInstance("MD5"));

        given().
                params("username", userName).
                params("password", md5Password).
                params("gender", "1").
                params("ip", "127.0.0.1").
        when().
                get("http://passport.api.vip.com/api/passport/login/login");

        String requestStr = "{";
        requestStr += "\"" + "username" + "\":" + "\"" + userName + "\"" + ",";
        requestStr += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
        requestStr += "\"" + "invite_code" + "\":" + "\"" + MagentoDB.getAvaliableInviteCode() + "\"";
        requestStr += "}";

        given().
                body(requestStr).
                header("Content-Type", "application/json; charset=utf-8").
                header("appid", "10001").
                when().
                post("http://shop-mapp.vipfashion.com/api/rest/customer/login").
                then().
                body("code", equalTo(1)).
                statusCode(200);
    }


//    @Test
//    @Source("data/magento/logintestdata.csv")
//    public void testLoginWithInviteCode(String platform, String username, String password, String invite_code, String expected_code) throws Exception{
//
//        String paramStr = "/" + platform;
//        paramStr += "/" + username;
//        paramStr += "/" + password;
//
//        given().
//                params("username", username).
//                params("password", password).
//                params("gender", "1").
//                params("ip", "127.0.0.1").
//        when().
//                get("http://192.168.201.65:8080/api/passport/login/login").prettyPrint();
//
//
//        given().
//                param("invite_code", invite_code).
//        when().
//                get("http://shop-mapp.vipfashion.com/api/rest/customer/login" + paramStr).
//        then().
//                body("code", equalTo(expected_code));
//    }


    @Test
    public void testLoginWithInvalidUser() throws Exception{
        String userName = "0000000000@test.com";
        String md5Password = "cc03e747a6afbbcbf8be7668acfebee5";

        given().
                params("username", userName).
                params("password", md5Password).
                params("gender", "1").
                params("ip", "127.0.0.1").
        when().
                get("http://passport.api.vip.com//api/passport/login/login").
        then().
                body("errorCode", equalTo(20002));


        String requestStr = "{";
        requestStr += "\"" + "username" + "\":" + "\"" + userName + "\"" + ",";
        requestStr += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
        requestStr += "\"" + "invite_code" + "\":" + "\"" + MagentoDB.getAvaliableInviteCode() + "\"";
        requestStr += "}";

        given().
                body(requestStr).
                header("Content-Type", "application/json; charset=utf-8").
                header("appid", "10001").
                when().
                post("http://shop-mapp.vipfashion.com/api/rest/customer/login").
        then().
                body("code", equalTo(40001)).
                statusCode(200);
    }

    @Test
    public void testLogout() throws Exception{
        // api to be implemented

    }

    @Test
    public void testGetUserInfo() throws Exception {
        User user = CommonMethod.registerNewUser();
        String userName = user.account;
        String md5Password = MD5Encoder.encodeByMD5("vipshop123456", MessageDigest.getInstance("MD5"));

        String requestStr = "{";
        requestStr += "\"" + "username" + "\":" + "\"" + userName + "\"" + ",";
        requestStr += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
        requestStr += "\"" + "invite_code" + "\":" + "\"" + MagentoDB.getAvaliableInviteCode() + "\"";
        requestStr += "}";

        String loginResponse =given().
                body(requestStr).
                header("Content-Type", "application/json; charset=utf-8").
                header("appid", "10001").
                when().
                post("http://shop-mapp.vipfashion.com/api/rest/customer/login").prettyPrint();

        System.out.print(loginResponse);

        int userId = with(loginResponse).get("data.result.user_id");
        String token = with(loginResponse).get("data.result.access_token");

        Assert.assertNotNull(token);

        InputStream jsonSchema = Thread.currentThread().getContextClassLoader().getResourceAsStream("json/userinfo_magento.json");

        given().
                header("accesstoken", token).
                header("appid", "10001").
                header("Content-Type", "application/json; charset=utf-8").
        when().
                get("http://shop-mapp.vipfashion.com/api/rest/customers/" + userId).
        then().
                body("code", equalTo(1)).
                body("data.email", equalTo(userName));
//                body(matchesJsonSchema(jsonSchema));
    }

    @Test
    public void testUserInfoUpdatedInMagentoOnly() throws Exception{
        User user = CommonMethod.login();

        String updatedLastName = "updatedName";
        String updatedBirthday = "1990-01-01";
        int updatedGender = 2;

        given().
                param("lastname", updatedLastName).
                param("dbo", updatedBirthday).
                param("gender", updatedGender).
        when().
                put("http://shop-mapp.vipfashion.com/api/rest/customers/" + user.userId);

        String updateInfoString = "{";
        updateInfoString += "\"lastname\": \"" + updatedLastName + "\"" + ",";
        updateInfoString += "\"dbo\": \"" + updatedBirthday + "\"" + ",";
        updateInfoString += "\"gender\": \"" + updatedGender + "\"";
        updateInfoString += "}";

        System.out.println(updateInfoString);

        given().
                request().
                body(updateInfoString).
                header("accesstoken", user.token).
                header("Content-Type", "application/json; charset=utf-8").
        when().
                put("http://shop-mapp.vipfashion.com/api/rest/customers/" + user.userId).prettyPrint();
//        then().
//                body("code", equalTo(1));

        //check user info is unchanged in passport
        given().
                header("accesstoken", user.token).
                header("Content-Type", "application/json; charset=utf-8").
        when().
                get("http://user.api.vip.com/users/" + user.userId + "/info/base").
        then().
                body("data.gender", not(updatedGender)).
                body("data.birthday", not(updatedBirthday));
    }

    public void createNewUserForTesting() throws Exception{
//        Long currentTime = System.currentTimeMillis();
//        String userName = currentTime + "@vip.com";
        for(int i = 1; i <= 10; ++i) {
            String userName = "shqa00" + i + "@vip.com";
            String password = "vipshop123456";
            String md5Password = MD5Encoder.encodeByMD5(password, MessageDigest.getInstance("MD5"));

            given().relaxedHTTPSValidation().
                    params("username", userName).
                    params("password", md5Password).
                    params("gender", "1").
                    params("ip", "127.0.0.1").
                    when().
                    get("http://passport.api.vip.com/api/passport/register/register").
                    then().
                    body("expends", notNullValue()).
                    body("errorCode", equalTo(0)).
                    statusCode(200);

            String requestStr = "{";
            requestStr += "\"" + "username" + "\":" + "\"" + userName + "\"" + ",";
            requestStr += "\"" + "password" + "\":" + "\"" + md5Password + "\"" + ",";
            requestStr += "\"" + "invite_code" + "\":" + "\"" + MagentoDB.getAvaliableInviteCode() + "\"";
            requestStr += "}";

            given().
                    body(requestStr).
                    header("Content-Type", "application/json; charset=utf-8").
                    header("appid", "10001").
                    when().
                    post("http://shop-mapp.vipfashion.com/api/rest/customer/login").
                    then().
                    body("code", equalTo(1)).
                    statusCode(200);
        }
    }
}
