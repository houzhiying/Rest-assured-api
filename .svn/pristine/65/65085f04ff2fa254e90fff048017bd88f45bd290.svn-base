package com.vip.apitest.luxury.magento;

import static com.jayway.restassured.RestAssured.given;
import static org.hamcrest.Matchers.equalTo;
import static org.hamcrest.Matchers.hasItem;

import java.io.UnsupportedEncodingException;

import org.databene.benerator.anno.Source;
import org.junit.BeforeClass;
import org.junit.Test;

import com.vip.apitest.luxury.BaseTestCase;
import com.vip.apitest.luxury.common.CommonMethod;

public class CartAddTest extends BaseTestCase{
	
	@BeforeClass
	public static void init() throws Exception{
		CommonMethod.getUidAndToken();
	}
	
	@Test
	public void testCartAdd_right() throws UnsupportedEncodingException {
		System.out.println("添加商品到购物车中");
		given().
			body("{\"products\": [{\"id\": 48,\"qty\": 1,\"super_attribute\":{\"138\": 10}}]}").
			header("accesstoken", CommonMethod.token).
			header("Content-Type", "application/json; charset=utf-8").
		when().
			put(CommonMethod.magento_uri+"/api/rest/checkout/carts/user?method=add").
		then().
			statusCode(200).
			body("code", equalTo(1)).
			body("data.msg", equalTo("success"));

	}
	@Test
	public void testCartAdd_qtyIsFour() throws UnsupportedEncodingException {
		System.out.println("件数大于3件时添加商品到购物车中");
		given().
			body("{\"products\": [{\"id\": 48,\"qty\": 4,\"super_attribute\":{\"138\": 10}}]}").
			header("accesstoken", CommonMethod.token).
			header("Content-Type", "application/json; charset=utf-8").
		when().
			put(CommonMethod.magento_uri+"/api/rest/checkout/carts/user?method=add").
		then().
			statusCode(200).
			body("code", equalTo(30003)).
			body("msg", equalTo("The maximum quantity allowed for purchase is 3."));
		
	}
	
	@Test
	@Source("data/magento/cart_add200.csv")
	public void testCartAdd_200(String testName, String productId, String qty, String attributeId, String valueId, String token, int code, String msg) throws UnsupportedEncodingException {
		System.out.println(testName);
		given().
			body("{\"products\": [{\"id\": "+productId+",\"qty\": "+qty+",\"super_attribute\":{\"attribute_id\": "+attributeId+",\"value_id\": "+valueId+"}}]}").
			header("accesstoken", token).
			header("Content-Type", "application/json; charset=utf-8").
		when().
			put(CommonMethod.magento_uri+"/api/rest/checkout/carts/user?method=add").
		then().
			body("code", equalTo(code)).
			body("msg", equalTo(msg));
	}
	
	@Test
	@Source("data/magento/cart_add500.csv")
	public void testCartAdd_500(String testName, String productId, String qty, String attributeId, String valueId, String token, int code, String msg) throws UnsupportedEncodingException {
		System.out.println(testName);
		given().
			body("{\"products\": [{\"id\": "+productId+",\"qty\": "+qty+",\"super_attribute\":{\"attribute_id\": "+attributeId+",\"value_id\": "+valueId+"}}]}").
			header("accesstoken", token).
			header("Content-Type", "application/json; charset=utf-8").
		when().
			put(CommonMethod.magento_uri+"/api/rest/checkout/carts/user?method=add").
		then().
		body("data.error.code", hasItem(code)).
		body("data.error.message", hasItem(msg));
	}
	
}
